{% extends 'layout.html' %}
{% block content %}

<section class="container my-4">

  <!-- NAVIGASI HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 style="color: #2c4f42;">
        <i class="fas fa-users me-2"></i>Manajemen Pengguna
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{{ url_for('admin_dashboard') }}" style="text-decoration: none; color: #2c4f42;">
              <i class="fas fa-home me-1"></i>Dashboard
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Manajemen Pengguna</li>
        </ol>
      </nav>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('admin_dashboard') }}" 
         class="btn btn-outline-primary" style="border-color: #2c4f42; color: #2c4f42;">
        <i class="fas fa-arrow-left me-1"></i>Kembali ke Dashboard
      </a>
      <a href="{{ url_for('cashflow_index') }}" class="btn btn-outline-success">
        <i class="fas fa-money-bill-wave me-1"></i>Cashflow
      </a>
      <a href="{{ url_for('products') }}" class="btn btn-outline-info">
        <i class="fas fa-box me-1"></i>Produk
      </a>
    </div>
  </div>

  <!-- STATISTIK USER -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Total Pengguna</h6>
              <h3>{{ total_users_count }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-users fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Pengguna Aktif</h6>
              <h3>{{ active_users_count }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-user-check fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Admin</h6>
              <h3>{{ admin_users_count }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-user-shield fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Baru Bulan Ini</h6>
              <h3>{{ new_users_count }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-user-plus fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FORM TAMBAH USER -->
  <div class="card mb-4" style="background-color: #fefcf5; border: 1px solid #d1d1d1;">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #2c4f42; color: white;">
      <h4 class="mb-0">
        <i class="fas fa-user-plus me-2"></i>Tambah Pengguna Baru
      </h4>
      <span class="badge bg-light text-dark">
        <i class="fas fa-user-shield me-1"></i>Admin: {{ session.full_name }}
      </span>
    </div>
    <div class="card-body">
      <form id="userForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label" style="color: #000;">
            <i class="fas fa-id-card me-1"></i>Nama Lengkap *
          </label>
          <input type="text" name="full_name" id="full_name" class="form-control" placeholder="Masukkan nama lengkap" required>
        </div>
        <div class="col-md-4">
          <label class="form-label" style="color: #000;">
            <i class="fas fa-envelope me-1"></i>Email *
          </label>
          <input type="email" name="email" id="email" class="form-control" placeholder="contoh@email.com" required>
        </div>
        <div class="col-md-4">
          <label class="form-label" style="color: #000;">
            <i class="fas fa-key me-1"></i>Password *
          </label>
          <input type="password" name="password" id="password" class="form-control" placeholder="Minimal 6 karakter" required>
        </div>
        <div class="col-md-6">
          <label class="form-label" style="color: #000;">
            <i class="fas fa-user-tag me-1"></i>Role *
          </label>
          <select name="role" id="role" class="form-select" required>
            <option value="">Pilih Role</option>
            <option value="admin">Admin</option>
            <option value="user">User</option>
            <option value="view_only">View Only</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label" style="color: #000;">
            <i class="fas fa-calendar me-1"></i>Tanggal Bergabung
          </label>
          <input type="date" name="join_date" id="join_date" class="form-control" value="{{ today }}">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success" style="background-color: #2c4f42; border-color: #2c4f42;" id="submitBtn">
            <i class="fas fa-plus me-1"></i>
            <span id="submitText">Tambah Pengguna</span>
            <div id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
          <small class="text-muted ms-2">* Field wajib diisi</small>
        </div>
      </form>
    </div>
  </div>

  <!-- TABEL DAFTAR USER -->
  <div class="card mb-4" style="background-color: #fefcf5; border: 1px solid #d1d1d1;">
    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #2c4f42; color: white;">
      <h4 class="mb-0">
        <i class="fas fa-list me-2"></i>Daftar Pengguna
      </h4>
      <span class="badge bg-light text-dark">
        <i class="fas fa-users me-1"></i>Total: {{ users|length }} pengguna
      </span>
    </div>
    <div class="card-body">
      
      {% if users %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead style="background-color: #d4b26a; color: #000;">
            <tr>
              <th><i class="fas fa-id-card me-1"></i>Nama</th>
              <th><i class="fas fa-envelope me-1"></i>Email</th>
              <th><i class="fas fa-user-tag me-1"></i>Role</th>
              <th><i class="fas fa-calendar me-1"></i>Tanggal Bergabung</th>
              <th><i class="fas fa-user-circle me-1"></i>Status</th>
              <th><i class="fas fa-cogs me-1"></i>Aksi</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            {% for user in users %}
            <tr style="color: #000;">
              <td>
                <strong>{{ user.full_name }}</strong>
                {% if user.id == session.user_id %}
                <span class="badge bg-primary ms-1">Anda</span>
                {% endif %}
              </td>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge 
                  {% if user.role == 'admin' %}bg-danger
                  {% elif user.role == 'user' %}bg-success
                  {% else %}bg-secondary{% endif %}">
                  {{ user.role | upper }}
                </span>
              </td>
              <td>{{ user.join_date or '-' }}</td>
              <td>
                <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                  {% if user.is_active %}AKTIF{% else %}NON-AKTIF{% endif %}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-warning edit-user" data-user-id="{{ user.id }}" 
                         data-full-name="{{ user.full_name }}" data-email="{{ user.email }}" 
                         data-role="{{ user.role }}" data-is-active="{{ user.is_active }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  {% if user.id != session.user_id %}
                    {% if user.is_active %}
                    <a href="{{ url_for('deactivate_user', user_id=user.id) }}" class="btn btn-secondary" 
                       onclick="return confirm('Non-aktifkan pengguna {{ user.full_name }}?')" title="Non-aktifkan">
                      <i class="fas fa-user-slash"></i>
                    </a>
                    {% else %}
                    <a href="{{ url_for('activate_user', user_id=user.id) }}" class="btn btn-success" 
                       onclick="return confirm('Aktifkan pengguna {{ user.full_name }}?')" title="Aktifkan">
                      <i class="fas fa-user-check"></i>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('delete_user', user_id=user.id) }}" class="btn btn-danger" 
                       onclick="return confirm('Yakin hapus pengguna {{ user.full_name }}?')">
                      <i class="fas fa-trash"></i>
                    </a>
                  {% else %}
                  <button class="btn btn-secondary" disabled title="Tidak dapat non-aktifkan akun sendiri">
                    <i class="fas fa-user-slash"></i>
                  </button>
                  <button class="btn btn-danger" disabled title="Tidak dapat menghapus akun sendiri">
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="alert alert-info text-center">
          <i class="fas fa-users fa-2x mb-3"></i>
          <h5>Belum ada pengguna</h5>
          <p class="mb-0">Tambahkan pengguna baru menggunakan form di atas.</p>
        </div>
      {% endif %}

    </div>
  </div>

</section>

<!-- Modal Edit User -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #2c4f42; color: white;">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Pengguna</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" name="user_id" id="edit_user_id">
          <div class="mb-3">
            <label class="form-label">Nama Lengkap</label>
            <input type="text" name="full_name" id="edit_full_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" id="edit_email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" id="edit_role" class="form-select" required>
              <option value="admin">Admin</option>
              <option value="user">User</option>
              <option value="view_only">View Only</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select name="is_active" id="edit_is_active" class="form-select" required>
              <option value="1">Aktif</option>
              <option value="0">Non-Aktif</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Password Baru (opsional)</label>
            <input type="password" name="new_password" id="edit_password" class="form-control" placeholder="Kosongkan jika tidak ingin mengubah">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="saveEditUser">Simpan Perubahan</button>
      </div>
    </div>
  </div>
</div>

<script>
// Fungsi untuk menampilkan alert
function showAlert(message, type) {
  const alertContainer = document.getElementById('alertContainer');
  const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
  
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Remove any existing alerts first
  const existingAlerts = document.querySelectorAll('.alert');
  existingAlerts.forEach(alert => alert.remove());
  
  alertContainer.innerHTML = '';
  alertContainer.appendChild(alertDiv);
  
  // Auto dismiss setelah 5 detik
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.classList.remove('show');
      setTimeout(() => alertDiv.remove(), 150);
    }
  }, 5000);
}

// AJAX untuk tambah user
document.getElementById('userForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const submitSpinner = document.getElementById('submitSpinner');
  
  // Validasi form
  const password = document.getElementById('password').value;
  if (password.length < 6) {
    showAlert('Password harus minimal 6 karakter!', 'error');
    return false;
  }
  
  // Tampilkan loading
  submitBtn.disabled = true;
  submitText.textContent = 'Menambahkan...';
  submitSpinner.classList.remove('d-none');
  
  // Kirim data via AJAX
  const formData = new FormData(this);
  
  fetch('{{ url_for("add_user") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    // Reset tombol
    submitBtn.disabled = false;
    submitText.textContent = 'Tambah Pengguna';
    submitSpinner.classList.add('d-none');
    
    if (data.success) {
      // Tampilkan pesan sukses
      showAlert(data.message, 'success');
      
      // Reset form
      document.getElementById('userForm').reset();
      document.getElementById('join_date').value = '{{ today }}'; // Reset tanggal ke hari ini
      
      // Refresh halaman setelah 1 detik
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      // Tampilkan pesan error
      showAlert(data.message, 'error');
    }
  })
  .catch(error => {
    // Reset tombol
    submitBtn.disabled = false;
    submitText.textContent = 'Tambah Pengguna';
    submitSpinner.classList.add('d-none');
    
    showAlert('Terjadi kesalahan saat menambah pengguna!', 'error');
    console.error('Error:', error);
  });
});

// Edit User Modal
document.querySelectorAll('.edit-user').forEach(button => {
  button.addEventListener('click', function() {
    const userId = this.getAttribute('data-user-id');
    const fullName = this.getAttribute('data-full-name');
    const email = this.getAttribute('data-email');
    const role = this.getAttribute('data-role');
    const isActive = this.getAttribute('data-is-active');
    
    document.getElementById('edit_user_id').value = userId;
    document.getElementById('edit_full_name').value = fullName;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_role').value = role;
    document.getElementById('edit_is_active').value = isActive === 'True' ? '1' : '0';
    document.getElementById('edit_password').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
  });
});

// Save Edit User
document.getElementById('saveEditUser').addEventListener('click', function() {
  const formData = new FormData(document.getElementById('editUserForm'));
  
  fetch('{{ url_for("edit_user") }}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert(data.message, 'success');
      const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
      modal.hide();
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      showAlert(data.message, 'error');
    }
  })
  .catch(error => {
    showAlert('Terjadi kesalahan saat mengupdate pengguna!', 'error');
    console.error('Error:', error);
  });
});

// Jalankan saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
  console.log('Manajemen Pengguna loaded');
});
</script>

{% endblock %}