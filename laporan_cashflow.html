{% extends 'layout.html' %}
{% block content %}

<section class="container my-4">

  <!-- NAVIGASI HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 style="color: #2c4f42;">
        <i class="fas fa-chart-pie me-2"></i>Laporan Cashflow Bulanan
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{{ url_for('admin_dashboard') if session.role == 'admin' else url_for('view_only') }}" 
               style="text-decoration: none; color: #2c4f42;">
              <i class="fas fa-home me-1"></i>Dashboard
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Laporan Cashflow</li>
        </ol>
      </nav>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('cashflow_index') }}" class="btn btn-outline-primary" 
         style="border-color: #2c4f42; color: #2c4f42;">
        <i class="fas fa-arrow-left me-1"></i>Kembali ke Cashflow
      </a>
    </div>
  </div>

  <!-- FILTER FORM -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header" style="background: linear-gradient(135deg, #2c4f42 0%, #3a6b5a 100%); color: white;">
      <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Laporan</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('cashflow_reports') }}" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-medium">Bulan</label>
          <select name="bulan" class="form-select" required>
            {% for i in range(1,13) %}
            <option value="{{ i }}" {% if i == selected_bulan %}selected{% endif %}>
              {{ month_names[i-1] }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-medium">Tahun</label>
          <select name="tahun" class="form-select" required>
            {% for year in available_years %}
            <option value="{{ year }}" {% if year == selected_tahun %}selected{% endif %}>
              {{ year }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary w-100" 
                  style="background: linear-gradient(135deg, #2c4f42 0%, #3a6b5a 100%); border: none;">
            <i class="fas fa-sync-alt me-1"></i>Terapkan Filter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Total Pengeluaran</h6>
              <h3>Rp {{ "{:,.0f}".format(total_pengeluaran) }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-money-bill-wave fa-2x"></i>
            </div>
          </div>
          <p class="card-text mb-0">
            {{ month_names[selected_bulan-1] }} {{ selected_tahun }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Jumlah Transaksi</h6>
              <h3>{{ transactions|length }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-receipt fa-2x"></i>
            </div>
          </div>
          <p class="card-text mb-0">Total transaksi bulan ini</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-info shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Kategori</h6>
              <h3>{{ pengeluaran_per_kategori|length }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-tags fa-2x"></i>
            </div>
          </div>
          <p class="card-text mb-0">Jenis kategori pengeluaran</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex gap-2 flex-wrap">
        <button onclick="window.print()" class="btn btn-secondary">
          <i class="fas fa-print me-1"></i>Print Laporan
        </button>
        <a href="{{ url_for('export_cashflow_excel') }}?bulan={{ selected_bulan }}&tahun={{ selected_tahun }}" 
           class="btn btn-success">
          <i class="fas fa-file-excel me-1"></i>Export Excel
        </a>
        <button class="btn btn-warning" onclick="exportToGoogleSheet()">
          <i class="fab fa-google me-1"></i>Export Google Sheet
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#emailModal">
          <i class="fas fa-envelope me-1"></i>Kirim Email
        </button>
      </div>
    </div>
  </div>

  <!-- CHART & STATISTICS -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header" style="background: linear-gradient(135deg, #2c4f42 0%, #3a6b5a 100%); color: white;">
          <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Pengeluaran per Kategori</h5>
        </div>
        <div class="card-body">
          <canvas id="categoryChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header" style="background: linear-gradient(135deg, #2c4f42 0%, #3a6b5a 100%); color: white;">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Ringkasan Kategori</h5>
        </div>
        <div class="card-body">
          {% for kategori, data in pengeluaran_per_kategori.items() %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-medium">{{ kategori }}</span>
              <span class="badge bg-primary">Rp {{ "{:,.0f}".format(data.total) }}</span>
            </div>
            <div class="progress mt-1" style="height: 8px;">
              <div class="progress-bar" role="progressbar" 
                   style="width: {{ (data.total / total_pengeluaran * 100) if total_pengeluaran > 0 else 0 }}%;
                          background-color: {{ ['#2c4f42', '#d4b26a', '#28a745', '#dc3545', '#6f42c1', '#fd7e14'][loop.index0 % 6] }};">
              </div>
            </div>
            <small class="text-muted">{{ data.count }} transaksi</small>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILED TRANSACTIONS -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center" 
         style="background: linear-gradient(135deg, #2c4f42 0%, #3a6b5a 100%); color: white;">
      <h5 class="mb-0">
        <i class="fas fa-list me-2"></i>Detail Transaksi {{ month_names[selected_bulan-1] }} {{ selected_tahun }}
      </h5>
      <span class="badge bg-light text-dark">
        {{ transactions|length }} transaksi
      </span>
    </div>
    <div class="card-body">
      {% if transactions %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Kategori</th>
              <th>Nama Item</th>
              <th>Jumlah</th>
              <th>Satuan</th>
              <th>Harga (Rp)</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
            <tr>
              <td>{{ transaction.tanggal }}</td>
              <td>
                <span class="badge 
                  {% if transaction.kategori == 'Bahan Pokok' %}bg-primary
                  {% elif transaction.kategori == 'Barang' %}bg-success
                  {% elif transaction.kategori == 'Jasa' %}bg-warning text-dark
                  {% else %}bg-secondary{% endif %}">
                  {{ transaction.kategori }}
                </span>
              </td>
              <td>{{ transaction.nama }}</td>
              <td>{{ transaction.jumlah or '-' }}</td>
              <td>{{ transaction.satuan or '-' }}</td>
              <td class="fw-bold text-success">Rp {{ "{:,.0f}".format(transaction.harga) }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot style="background-color: #f8f9fa;">
            <tr>
              <td colspan="5" class="fw-bold text-end">TOTAL PENGELUARAN:</td>
              <td class="fw-bold text-success fs-5">Rp {{ "{:,.0f}".format(total_pengeluaran) }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
        <h5 class="text-muted">Tidak ada data transaksi</h5>
        <p class="text-muted">Tidak ada transaksi untuk periode {{ month_names[selected_bulan-1] }} {{ selected_tahun }}</p>
      </div>
      {% endif %}
    </div>
  </div>

</section>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #2c4f42 0%, #3a6b5a 100%); color: white;">
        <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>Kirim Laporan via Email</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="emailForm">
          <div class="mb-3">
            <label class="form-label">Email Tujuan</label>
            <input type="email" class="form-control" id="emailTo" 
                   placeholder="contoh@email.com" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Periode Laporan</label>
            <input type="text" class="form-control" 
                   value="{{ month_names[selected_bulan-1] }} {{ selected_tahun }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Total Transaksi</label>
            <input type="text" class="form-control" 
                   value="{{ transactions|length }} transaksi" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Total Pengeluaran</label>
            <input type="text" class="form-control" 
                   value="Rp {{ '{:,.0f}'.format(total_pengeluaran) }}" readonly>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" onclick="sendEmailReport()">
          <i class="fas fa-paper-plane me-1"></i>Kirim Laporan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- PRINT STYLES -->
<style>
@media print {
  .btn, .breadcrumb, .card-header .badge, .modal, .navbar, footer {
    display: none !important;
  }
  
  .card {
    border: 1px solid #000 !important;
    box-shadow: none !important;
  }
  
  .card-header {
    background: #f8f9fa !important;
    color: #000 !important;
    border-bottom: 1px solid #000 !important;
  }
  
  .table {
    font-size: 12px;
  }
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const chartData = {{ chart_data|tojson }};
  
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: chartData.labels,
      datasets: [{
        data: chartData.data,
        backgroundColor: [
          '#2c4f42', '#d4b26a', '#28a745', '#dc3545', 
          '#6f42c1', '#fd7e14', '#20c997', '#e83e8c'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: Rp ${value.toLocaleString()} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
});

// Export to Google Sheet (Simulasi)
function exportToGoogleSheet() {
  // Simulasi export ke Google Sheet
  // Dalam implementasi nyata, ini akan mengintegrasikan dengan Google Sheets API
  const bulan = {{ selected_bulan }};
  const tahun = {{ selected_tahun }};
  
  // Tampilkan pesan simulasi
  alert(`Fitur Export Google Sheet untuk ${getMonthName(bulan)} ${tahun}\n\nFitur ini akan mengintegrasikan dengan Google Sheets API untuk mengekspor data secara langsung ke Google Sheet.`);
  
  // TODO: Implementasi Google Sheets API integration
  console.log('Export to Google Sheet:', { bulan, tahun });
}

function getMonthName(month) {
  const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  return months[month - 1];
}

// Send Email Report
function sendEmailReport() {
  const emailTo = document.getElementById('emailTo').value;
  const bulan = {{ selected_bulan }};
  const tahun = {{ selected_tahun }};
  
  if (!emailTo) {
    alert('Email tujuan harus diisi');
    return;
  }
  
  // Tampilkan loading
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Mengirim...';
  btn.disabled = true;
  
  fetch('{{ url_for("send_cashflow_email") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      email: emailTo,
      bulan: bulan,
      tahun: tahun
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      // Tutup modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
      modal.hide();
      // Reset form
      document.getElementById('emailForm').reset();
    } else {
      alert(data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Terjadi kesalahan saat mengirim email');
  })
  .finally(() => {
    // Reset button
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

// Initialize modal events
document.addEventListener('DOMContentLoaded', function() {
  const emailModal = document.getElementById('emailModal');
  if (emailModal) {
    emailModal.addEventListener('shown.bs.modal', function () {
      document.getElementById('emailTo').focus();
    });
  }
});
</script>

{% endblock %}